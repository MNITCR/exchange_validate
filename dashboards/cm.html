// =================Top up=====================
if(isset($_POST['top_up'])){
    $numQr = trim($_POST['numQr']);
    $simNumber = $_COOKIE['simNumber'];
    $id_number = $_POST['id_number'];
    $id = $_POST['rg_id'];

    if (empty($numQr)) {
        echo "<script>alert('This input can\'t be null or empty !!!');</script>";
    }
    elseif($simNumber == $numQr){
        // Check if the num_bland value already exists in the database
        $checkQuery = "SELECT * FROM main_bland_table WHERE num_bland = '$numQr'";
        $checkResult = mysqli_query($conn, $checkQuery);

        if (mysqli_num_rows($checkResult) > 0) {
            // num_bland value already exists, show an error message
            echo "<script>alert('This card number is already used. Please choose a different one.');</script>";
        }
        else{
            // Determine the sv_by value based on the length of num_bland
            $sv_by = '';
            $num_bland_length = strlen($numQr);

            if ($num_bland_length == 15) {
                $sv_by = 'Smart';
            } elseif ($num_bland_length == 14) {
                $sv_by = 'Metfone';
            } elseif ($num_bland_length == 10) {
                $sv_by = 'Cellcard';
            }

            // Check if the phone number already exists in the database
            $checkQuery = "SELECT * FROM main_bland_table WHERE id_number = '$id_number' AND register_id = '$id'";
            $checkResult = mysqli_query($conn, $checkQuery);

            if (mysqli_num_rows($checkResult) > 0) {
                // Phone number already exists, increment the main_bland value
                $updateQuery = "UPDATE main_bland_table SET main_bland = main_bland + 1, num_bland = '$numQr', sv_by = '$sv_by'  WHERE id_number = '$id_number' AND register_id = '$id'";

                if (mysqli_query($conn, $updateQuery)) {
                    // Top-up successful, you can redirect or display a success message
                    echo "<script>alert('Top up successful.');window.location.href=('dashboard.php');</script>";
                } else {
                    // Handle the case where the update query fails
                    echo "<script>alert('Error Top up: " . mysqli_error($conn) . "');</script>";
                }
            } else {
                // Insert new user data into the database
                $insertQuery = "INSERT INTO main_bland_table (id_number, main_bland, num_bland, sv_by, register_id) VALUES ('$id_number', 1, '$numQr', '$sv_by', '$id')";

                if (mysqli_query($conn, $insertQuery)) {
                    // Registration successful, you can redirect or display a success message
                    echo "<script>alert('Top up successful.');window.location.href=('dashboard.php');</script>";
                } else {
                    // Handle the case where the insert query fails
                    echo "<script>alert('Error Top up: " . mysqli_error($conn) . "');</script>";
                }
            }
        }
    } else {
        echo "<script>alert('This card number is expired')</script>";
    }
}
